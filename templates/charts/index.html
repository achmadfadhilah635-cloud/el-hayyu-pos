{% extends "layouts/base.html" %}
{% load static %}
{% load humanize %}

{% block title %} Analisa Penjualan {% endblock title %}

{% block content %}

<div class="container-fluid py-4">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header pb-0">
          <h6>Analisa Penjualan (Top Produk)</h6>
          <p class="text-sm mb-0">
            <i class="fa fa-chart-pie text-info" aria-hidden="true"></i>
            Grafik Penjualan Barang Berdasarkan Jumlah Terjual
          </p>
        </div>
        <div class="card-body p-3">
          <div class="row">
            <!-- Kolom 1: Grafik -->
            <div class="col-md-7">
              <div id="sales-pie-chart" style="min-height: 350px;"></div>
            </div>

            <!-- Kolom 2: Detail Text (Legend + Info Data) -->
            <div class="col-md-5">
              <div class="table-responsive" style="max-height: 350px; overflow-y: auto;">
                <table class="table align-items-center mb-0">
                  <thead class="sticky-top bg-white">
                    <tr>
                      <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Barang</th>
                      <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Qty
                      </th>
                      <th class="text-end text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 pe-2">
                        Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for data in sales_data %}
                    <tr>
                      <td>
                        <div class="d-flex px-2 py-1">
                          <div class="d-flex flex-column justify-content-center">
                            <h6 class="mb-0 text-xs">{{ data.produk__nama_barang }}</h6>
                          </div>
                        </div>
                      </td>
                      <td class="align-middle text-center">
                        <span class="text-secondary text-xs font-weight-bold">{{ data.total_qty }}</span>
                      </td>
                      <td class="align-middle text-end">
                        <span class="text-success text-xs font-weight-bold">Rp {{ data.total_sales|intcomma }}</span>
                      </td>
                    </tr>
                    {% empty %}
                    <tr>
                      <td colspan="3" class="text-center text-xs">Belum ada data.</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- STATISTIK PENJUALAN -->
  <div class="row justify-content-center mt-4">
    <!-- CARD HARIAN -->
    <div class="col-md-4 mb-3">
      <div class="card bg-gradient-success shadow" style="cursor: pointer;" data-bs-toggle="modal"
        data-bs-target="#modal-today">
        <div class="card-body p-3">
          <div class="row">
            <div class="col-8">
              <div class="numbers">
                <p class="text-sm mb-0 text-white font-weight-bold text-uppercase">Penjualan Hari Ini</p>
                <h5 class="font-weight-bolder text-white mb-0">
                  Rp {{ sales_today|intcomma }}
                  <span class="text-xs d-block mt-1 opacity-8">{{ qty_today }} Items Terjual</span>
                  <span class="text-xxs text-white opacity-8 fst-italic mt-2">(Klik untuk detail)</span>
                </h5>
              </div>
            </div>
            <div class="col-4 text-end">
              <div class="icon icon-shape bg-white shadow text-center border-radius-md">
                <i class="ni ni-money-coins text-success text-lg opacity-10" aria-hidden="true"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- CARD BULANAN -->
    <div class="col-md-4 mb-3">
      <div class="card bg-gradient-primary shadow" style="cursor: pointer;" data-bs-toggle="modal"
        data-bs-target="#modal-month">
        <div class="card-body p-3">
          <div class="row">
            <div class="col-8">
              <div class="numbers">
                <p class="text-sm mb-0 text-white font-weight-bold text-uppercase">Penjualan Bulan Ini</p>
                <h5 class="font-weight-bolder text-white mb-0">
                  Rp {{ sales_month|intcomma }}
                  <span class="text-xs d-block mt-1 opacity-8">{{ qty_month }} Items Terjual</span>
                  <span class="text-xxs text-white opacity-8 fst-italic mt-2">(Klik untuk detail)</span>
                </h5>
              </div>
            </div>
            <div class="col-4 text-end">
              <div class="icon icon-shape bg-white shadow text-center border-radius-md">
                <i class="ni ni-calendar-grid-58 text-primary text-lg opacity-10" aria-hidden="true"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODAL DETAIL HARI INI -->
<div class="modal fade" id="modal-today" tabindex="-1" role="dialog" aria-labelledby="modal-today" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title" id="modal-title-default">Detail Penjualan Hari Ini</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">×</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="table-responsive">
          <table class="table align-items-center mb-0">
            <thead>
              <tr>
                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Barang</th>
                <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Qty</th>
                <th class="text-end text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Total</th>
              </tr>
            </thead>
            <tbody>
              {% for item in items_today %}
              <tr>
                <td>
                  <h6 class="mb-0 text-sm">{{ item.produk__nama_barang }}</h6>
                </td>
                <td class="align-middle text-center"><span class="text-secondary text-xs font-weight-bold">{{
                    item.total_qty }}</span></td>
                <td class="align-middle text-end"><span class="text-success text-xs font-weight-bold">Rp {{
                    item.subtotal|intcomma }}</span></td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="3" class="text-center text-sm">Belum ada penjualan hari ini.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-link  ml-auto" data-bs-dismiss="modal">Tutup</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL DETAIL BULAN INI -->
<div class="modal fade" id="modal-month" tabindex="-1" role="dialog" aria-labelledby="modal-month" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title" id="modal-title-default">Detail Penjualan Bulan Ini</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">×</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
          <table class="table align-items-center mb-0">
            <thead>
              <tr>
                <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Barang</th>
                <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Qty</th>
                <th class="text-end text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Total</th>
              </tr>
            </thead>
            <tbody>
              {% for item in items_month %}
              <tr>
                <td>
                  <h6 class="mb-0 text-sm">{{ item.produk__nama_barang }}</h6>
                </td>
                <td class="align-middle text-center"><span class="text-secondary text-xs font-weight-bold">{{
                    item.total_qty }}</span></td>
                <td class="align-middle text-end"><span class="text-success text-xs font-weight-bold">Rp {{
                    item.subtotal|intcomma }}</span></td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="3" class="text-center text-sm">Belum ada penjualan bulan ini.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-link  ml-auto" data-bs-dismiss="modal">Tutup</button>
      </div>
    </div>
  </div>
</div>

{% endblock content %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Data dari Django Views (Safe JSON)
    var chartLabels = JSON.parse('{{ chart_labels|safe }}');
    var chartSeries = JSON.parse('{{ chart_series|safe }}');

    var options = {
      series: chartSeries,
      chart: {
        width: '100%',
        type: 'pie',
        height: 400
      },
      labels: chartLabels,
      theme: {
        monochrome: {
          enabled: true
        }
      },
      plotOptions: {
        pie: {
          dataLabels: {
            offset: -5
          }
        }
      },
      dataLabels: {
        formatter(val, opts) {
          const name = opts.w.globals.labels[opts.seriesIndex]
          return [name, val.toFixed(1) + '%']
        }
      },
      legend: {
        position: 'bottom'
      },
      responsive: [{
        breakpoint: 480,
        options: {
          chart: {
            width: 300
          },
          legend: {
            position: 'bottom'
          }
        }
      }]
    };

    var chart = new ApexCharts(document.querySelector("#sales-pie-chart"), options);
    chart.render();
  });
</script>
{% endblock extra_js %}
{% extends 'layouts/base.html' %}
{% load static %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header pb-0 p-3">
                    <div class="row">
                        <div class="col-6 d-flex align-items-center">
                            <h6 class="mb-0">Kasir / Point of Sale</h6>
                        </div>
                        <div class="col-6 text-end">
                            <button class="btn btn-outline-primary btn-sm mb-0" onclick="focusInput()">
                                <i class="fas fa-barcode me-1"></i> Mode Scan
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card-body p-3">
                    <div class="form-group mb-3">
                        <div class="input-group input-group-lg">
                            <span class="input-group-text bg-light"><i class="fas fa-barcode"></i></span>
                            <input type="text" id="barcodeInput" class="form-control" placeholder="Scan Barcode atau Ketik Nama Barang..." autocomplete="off">
                        </div>
                        <small class="text-muted text-xs ms-1">Tekan <b>Enter</b> setelah scan/ketik untuk menambahkan barang.</small>
                    </div>

                    <div class="table-responsive">
                        <table class="table align-items-center mb-0">
                            <thead>
                                <tr>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Barang</th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Harga</th>
                                    <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Qty</th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Subtotal</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="cartTable">
                                </tbody>
                        </table>
                    </div>
                    
                    <div id="emptyState" class="text-center py-5">
                        <i class="ni ni-cart text-secondary text-4xl opacity-2" style="font-size: 3rem;"></i>
                        <p class="text-sm mt-3 text-secondary">Keranjang masih kosong.</p>
                    </div>

                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-body p-3">
                    <h6 class="text-uppercase text-body text-xs font-weight-bolder">Ringkasan</h6>
                    <div class="d-flex justify-content-between mt-4">
                        <span class="mb-2 text-sm">Total:</span>
                        <span class="text-dark font-weight-bold ms-2" id="grandTotalDisplay">Rp 0</span>
                    </div>
                    
                    <hr class="horizontal dark my-3">
                    
                    <div class="form-group">
                        <label class="text-xs">Uang Diterima (Rp)</label>
                        <input type="number" id="uangBayar" class="form-control" placeholder="0" oninput="hitungKembalian()">
                    </div>
                    
                    <div class="d-flex justify-content-between mt-2">
                        <span class="mb-2 text-sm">Kembalian:</span>
                        <span class="text-success font-weight-bold ms-2" id="kembalianDisplay">Rp 0</span>
                    </div>

                    <button class="btn bg-gradient-primary w-100 mt-4 mb-0" onclick="prosesBayar()">
                        <i class="ni ni-check-bold me-1"></i> Proses Transaksi
                    </button>
                </div>
            </div>
        </div>

    </div>
</div>

<audio id="beepSound" src="https://www.soundjay.com/button/beep-07.wav" preload="auto"></audio>

{% endblock content %}

{% block extra_js %}
<script>
    let cart = [];
    const barcodeInput = document.getElementById('barcodeInput');
    const beepSound = document.getElementById('beepSound');

    // 1. AUTO FOCUS SAAT HALAMAN DIBUKA
    window.onload = function() {
        barcodeInput.focus();
    };

    function focusInput() {
        barcodeInput.focus();
    }

    // 2. EVENT LISTENER INPUT (SCANNER)
    barcodeInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault(); // Jangan refresh halaman
            let code = barcodeInput.value.trim();
            if(code) {
                cariBarang(code);
            }
        }
    });

    // 3. CARI BARANG KE API
    function cariBarang(keyword) {
        fetch(`/api/get-product/?term=${keyword}`)
            .then(res => res.json())
            .then(data => {
                if (data.results && data.results.length > 0) {
                    // Ambil hasil pertama (paling cocok)
                    let item = data.results[0];
                    tambahKeKeranjang(item);
                    
                    // Reset input & Bunyikan Beep
                    barcodeInput.value = '';
                    beepSound.play(); 
                } else {
                    alert('âŒ Barang tidak ditemukan!');
                    barcodeInput.value = ''; // Reset meski gagal
                }
            })
            .catch(err => console.error(err));
    }

    // 4. LOGIKA KERANJANG (SAMA SEPERTI SEBELUMNYA)
    function tambahKeKeranjang(item) {
        document.getElementById('emptyState').classList.add('d-none');
        
        let existingItem = cart.find(x => x.id === item.id);
        if(existingItem) {
            existingItem.qty += 1;
            existingItem.subtotal = existingItem.qty * existingItem.harga;
        } else {
            cart.push({
                id: item.id,
                nama: item.nama,
                harga: item.harga,
                qty: 1,
                subtotal: item.harga
            });
        }
        renderTable();
    }

    function renderTable() {
        const tbody = document.getElementById('cartTable');
        tbody.innerHTML = '';
        let total = 0;

        cart.forEach((item, index) => {
            total += item.subtotal;
            tbody.innerHTML += `
                <tr>
                    <td>
                        <div class="d-flex px-2 py-1">
                            <div class="d-flex flex-column justify-content-center">
                                <h6 class="mb-0 text-sm">${item.nama}</h6>
                            </div>
                        </div>
                    </td>
                    <td><p class="text-xs font-weight-bold mb-0">Rp ${item.harga}</p></td>
                    <td class="align-middle text-center text-sm">
                        <button class="btn btn-xs btn-outline-secondary mb-0 px-2" onclick="ubahQty(${index}, -1)">-</button>
                        <span class="mx-2 text-xs font-weight-bold">${item.qty}</span>
                        <button class="btn btn-xs btn-outline-secondary mb-0 px-2" onclick="ubahQty(${index}, 1)">+</button>
                    </td>
                    <td class="align-middle">
                        <span class="text-secondary text-xs font-weight-bold">Rp ${item.subtotal}</span>
                    </td>
                    <td class="align-middle">
                        <a href="javascript:;" class="text-secondary font-weight-bold text-xs" onclick="hapusItem(${index})">
                            <i class="fas fa-trash text-danger"></i>
                        </a>
                    </td>
                </tr>
            `;
        });

        document.getElementById('grandTotalDisplay').innerText = "Rp " + total;
        hitungKembalian();
    }

    function ubahQty(index, delta) {
        cart[index].qty += delta;
        if(cart[index].qty <= 0) {
            cart.splice(index, 1);
        } else {
            cart[index].subtotal = cart[index].qty * cart[index].harga;
        }
        renderTable();
        barcodeInput.focus(); // Balikin fokus ke scanner
    }

    function hapusItem(index) {
        cart.splice(index, 1);
        renderTable();
        barcodeInput.focus();
    }

    function hitungKembalian() {
        let total = cart.reduce((sum, item) => sum + item.subtotal, 0);
        let bayar = document.getElementById('uangBayar').value || 0;
        let kembalian = bayar - total;
        
        let display = document.getElementById('kembalianDisplay');
        display.innerText = "Rp " + kembalian;
        
        if(kembalian < 0) {
            display.classList.remove('text-success');
            display.classList.add('text-danger');
        } else {
            display.classList.remove('text-danger');
            display.classList.add('text-success');
        }
    }

    function prosesBayar() {
        if(cart.length === 0) return alert("Keranjang kosong!");
        let total = cart.reduce((sum, item) => sum + item.subtotal, 0);
        let bayar = document.getElementById('uangBayar').value || 0;

        if(bayar < total) return alert("Uang pembayaran kurang!");

        // Kirim ke API
        fetch('/api/simpan-transaksi/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                items: cart,
                total_belanja: total,
                uang_bayar: bayar
            })
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === 'success') {
                // Redirect ke Halaman Cetak Struk / Billing
                if(confirm("Transaksi Berhasil! Cetak Struk?")) {
                    window.open("/cetak-struk/" + data.transaksi_id + "/", "_blank");
                }
                location.reload(); 
            } else {
                alert("Gagal: " + data.message);
            }
        });
    }
</script>
{% endblock extra_js %}
{% extends 'layouts/base.html' %}
{% load static %}

{% block content %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<div class="container-fluid py-4">
    <div class="row">
        
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header pb-0 p-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0"><i class="fas fa-shopping-cart text-primary me-2"></i>Kasir / Transaksi</h6>
                        
                        <button class="btn btn-warning btn-sm mb-0" type="button" onclick="toggleKamera()">
                            <i class="fas fa-camera me-1"></i> Scan Kamera
                        </button>
                    </div>

                    <div id="area-kamera" class="mb-3 text-center" style="display:none;">
                        <div id="reader" style="width: 100%; max-width: 400px; margin: auto;"></div>
                        <button class="btn btn-danger btn-xs mt-2" onclick="stopKamera()">Tutup Kamera</button>
                    </div>

                    <div class="form-group mb-0">
                        <div class="input-group input-group-lg">
                            <span class="input-group-text"><i class="fas fa-barcode"></i></span>
                            <input type="text" id="barcode_input" class="form-control" placeholder="Scan Barcode / Ketik Kode..." autofocus>
                            <button class="btn btn-primary mb-0" type="button" onclick="cariBarang()">
                                <i class="fas fa-search"></i> Cari
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card-body p-3">
                    <div class="table-responsive">
                        <table class="table align-items-center mb-0">
                            <thead>
                                <tr>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Nama Barang</th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Harga</th>
                                    <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Qty</th>
                                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Subtotal</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="tabel_keranjang">
                                </tbody>
                        </table>
                    </div>
                    
                    <div id="empty_cart_msg" class="text-center mt-4">
                        <i class="fas fa-box-open fa-3x text-secondary mb-3"></i>
                        <p class="text-sm text-muted">Keranjang masih kosong.</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card bg-white shadow border-0">
                <div class="card-header bg-gradient-primary py-3">
                    <h6 class="text-white font-weight-bold text-center mb-0">
                        <i class="ni ni-money-coins me-2"></i> PEMBAYARAN
                    </h6>
                </div>
                
                <div class="card-body px-lg-4 py-lg-4">
                    <div class="text-center mb-3">
                        <span class="text-muted text-uppercase text-xs font-weight-bold">Total Tagihan:</span>
                        <h3 class="font-weight-bolder text-primary mt-2" id="label_total">Rp 0</h3>
                    </div>

                    <hr class="dark horizontal my-3">
                    
                    <form role="form">
                        <div class="form-group mb-3">
                            <label class="form-control-label text-xs">Uang Tunai (Bayar)</label>
                            <div class="input-group input-group-alternative border border-light shadow-sm rounded">
                                <span class="input-group-text bg-white py-1"><i class="fas fa-wallet text-success text-sm"></i></span>
                                <input class="form-control ps-2" placeholder="0" type="number" id="input_bayar" style="font-weight: bold; font-size: 1rem;">
                            </div>
                        </div>
                        
                        <div class="card border mb-3 shadow-none">
                            <div class="card-body py-2 px-3 d-flex justify-content-between align-items-center">
                                <span class="text-xs font-weight-bold text-muted">Kembalian:</span>
                                <h5 class="text-success font-weight-bold mb-0" id="label_kembali" style="font-size: 1rem;">Rp 0</h5>
                            </div>
                        </div>

                        <div class="text-center mt-3">
                            <button type="button" class="btn bg-gradient-success w-100 mb-0" onclick="selesaikanTransaksi()">
                                <i class="ni ni-check-bold me-1"></i> BAYAR SEKARANG
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
    // --- VARIABEL GLOBAL ---
    let keranjang = []; 
    let html5QrcodeScanner = null;

    // =========================================
    // 1. KAMERA & SCANNER LOGIC
    // =========================================
    function toggleKamera() {
        const area = document.getElementById('area-kamera');
        if (area.style.display === 'none') {
            area.style.display = 'block';
            startScanner();
        } else {
            stopKamera();
        }
    }

    function startScanner() {
        if (typeof Html5QrcodeScanner === 'undefined') {
            alert("Library Scanner belum siap. Cek koneksi internet.");
            return;
        }
        html5QrcodeScanner = new Html5QrcodeScanner(
            "reader", { fps: 10, qrbox: 250 }
        );
        html5QrcodeScanner.render(onScanSuccess);
    }

    function onScanSuccess(decodedText, decodedResult) {
        console.log(`Code scanned = ${decodedText}`);
        document.getElementById('barcode_input').value = decodedText;
        cariBarang(); // Otomatis cari setelah scan
    }

    function stopKamera() {
        if (html5QrcodeScanner) {
            html5QrcodeScanner.clear();
        }
        document.getElementById('area-kamera').style.display = 'none';
    }


    // =========================================
    // 2. CARI BARANG & KERANJANG
    // =========================================
    const inputBarcode = document.getElementById('barcode_input');
    
    // Event Listener Enter
    inputBarcode.addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            cariBarang();
        }
    });

    function cariBarang() {
        let kode = inputBarcode.value;
        if(!kode) return;

        // PENTING: Parameter URL harus 'term' sesuai views.py yang kita buat sebelumnya
        fetch(`/api/get_product/?term=${kode}`)
            .then(response => response.json())
            .then(data => {
                if(data.results.length > 0) {
                    // Ambil hasil pertama
                    tambahKeKeranjang(data.results[0]);
                    
                    inputBarcode.value = ""; 
                    inputBarcode.focus();    
                } else {
                    alert("Barang tidak ditemukan!");
                    inputBarcode.select();   
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert("Gagal koneksi ke server.");
            });
    }

    function tambahKeKeranjang(barang) {
        // Cek barang di keranjang
        let itemExist = keranjang.find(item => item.id === barang.id);

        if(itemExist) {
            itemExist.qty += 1;
        } else {
            keranjang.push({
                id: barang.id,
                nama: barang.nama,
                harga: parseInt(barang.harga),
                qty: 1,
                kode: barang.kode_barang
            });
        }
        updateTampilan();
    }

    function updateTampilan() {
        const tabel = document.getElementById('tabel_keranjang');
        const emptyMsg = document.getElementById('empty_cart_msg');
        let totalBelanja = 0;

        tabel.innerHTML = "";

        if(keranjang.length === 0) {
            emptyMsg.style.display = 'block';
        } else {
            emptyMsg.style.display = 'none';
            
            keranjang.forEach((item, index) => {
                let subtotal = item.harga * item.qty;
                totalBelanja += subtotal;

                let row = `
                    <tr>
                        <td>
                            <div class="d-flex px-2 py-1">
                                <div class="d-flex flex-column justify-content-center">
                                    <h6 class="mb-0 text-sm">${item.nama}</h6>
                                    <span class="text-xs text-secondary">${item.kode}</span>
                                </div>
                            </div>
                        </td>
                        <td>
                            <p class="text-xs font-weight-bold mb-0">Rp ${item.harga.toLocaleString('id-ID')}</p>
                        </td>
                        <td class="align-middle text-center">
                            <button class="btn btn-xs btn-outline-primary px-2 py-1 mb-0" onclick="ubahQty(${index}, -1)">-</button>
                            <span class="text-secondary text-xs font-weight-bold mx-2">${item.qty}</span>
                            <button class="btn btn-xs btn-outline-primary px-2 py-1 mb-0" onclick="ubahQty(${index}, 1)">+</button>
                        </td>
                        <td class="align-middle">
                            <span class="text-secondary text-xs font-weight-bold">Rp ${subtotal.toLocaleString('id-ID')}</span>
                        </td>
                        <td class="align-middle">
                            <a href="javascript:;" class="text-danger font-weight-bold text-xs" onclick="hapusItem(${index})">
                                <i class="fas fa-trash"></i>
                            </a>
                        </td>
                    </tr>
                `;
                tabel.innerHTML += row;
            });
        }

        // Update Total
        document.getElementById('label_total').innerText = "Rp " + totalBelanja.toLocaleString('id-ID');
        
        // Update Kembalian juga saat barang berubah
        hitungKembalian(); 
    }

    function ubahQty(index, jumlah) {
        keranjang[index].qty += jumlah;
        if(keranjang[index].qty <= 0) {
            hapusItem(index);
        } else {
            updateTampilan();
        }
    }

    function hapusItem(index) {
        keranjang.splice(index, 1);
        updateTampilan();
    }


    // =========================================
    // 3. LOGIKA PEMBAYARAN & KEMBALIAN (REQ MAS)
    // =========================================
    const inputBayar = document.getElementById('input_bayar');

    // Event Listener saat mengetik uang bayar
    inputBayar.addEventListener('keyup', function() {
        hitungKembalian();
    });

    function hitungKembalian() {
        // Ambil total belanja saat ini
        let total = keranjang.reduce((sum, item) => sum + (item.harga * item.qty), 0);
        
        let bayar = parseInt(inputBayar.value) || 0;
        let kembali = bayar - total;
        
        let labelKembali = document.getElementById('label_kembali');
        
        if(kembali >= 0) {
            // Uang Cukup
            labelKembali.innerText = "Rp " + kembali.toLocaleString('id-ID');
            labelKembali.className = "text-success font-weight-bold mb-0"; 
        } else {
            // Uang Kurang
            labelKembali.innerText = "Kurang Rp " + Math.abs(kembali).toLocaleString('id-ID');
            labelKembali.className = "text-danger font-weight-bold mb-0";
        }
    }

    function selesaikanTransaksi() {
        if(keranjang.length === 0) {
            alert("Keranjang kosong!");
            return;
        }

        let total = keranjang.reduce((sum, item) => sum + (item.harga * item.qty), 0);
        let uangBayar = parseInt(inputBayar.value) || 0;
        
        if(uangBayar < total) {
            alert("Uang pembayaran kurang!");
            return;
        }

        // Siapkan Data
        let dataTransaksi = {
            keranjang: keranjang,
            bayar: uangBayar,
            total: total
        };

        // Kirim ke Server
        let btn = document.querySelector("button[onclick='selesaikanTransaksi()']");
        let txtAsli = btn.innerHTML;
        btn.innerHTML = "<i class='fas fa-spinner fa-spin'></i> Memproses...";
        btn.disabled = true;

        fetch('/api/simpan_transaksi/', {  // Pastikan URL API sesuai urls.py
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dataTransaksi)
        })
        .then(response => response.json())
        .then(data => {
            if(data.status === 'success') {
                alert("✅ Transaksi Berhasil!\nNo Struk: " + data.no_struk);
                
                // Reset
                keranjang = [];
                updateTampilan();
                inputBayar.value = "";
                document.getElementById('label_kembali').innerText = "Rp 0";
                
                // Opsional: window.open(`/kasir/cetak/${data.no_struk}`, '_blank');
            } else {
                alert("❌ Gagal: " + data.message);
            }
        })
        .catch(error => console.error('Error:', error))
        .finally(() => {
            btn.innerHTML = txtAsli;
            btn.disabled = false;
        });
    }

</script>
{% endblock extra_js %}